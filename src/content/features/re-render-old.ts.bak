import { marked } from 'marked';
import markedKatex from 'marked-katex-extension';

/**
 * Styles for the re-render panel (overlay + modal)
 */
const panelStyles = `
.copyllm-panel-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 999998;
  backdrop-filter: blur(2px);
}

.copyllm-panel {
  position: fixed;
  top: 10%;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 900px;
  height: 80vh;
  background: white;
  border-radius: 12px;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  display: flex;
  flex-direction: column;
  z-index: 999999;
  overflow: hidden;
}

.copyllm-panel-header {
  padding: 16px 20px;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f9fafb;
}

.copyllm-panel-title {
  font-size: 18px;
  font-weight: 600;
  color: #111827;
  margin: 0;
}

.copyllm-panel-close {
  background: none;
  border: none;
  font-size: 28px;
  color: #6b7280;
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  transition: all 0.15s;
}

.copyllm-panel-close:hover {
  background: #e5e7eb;
  color: #111827;
}

.copyllm-panel-body {
  flex: 1;
  overflow: hidden;
  background: white;
}

.copyllm-panel-iframe {
  width: 100%;
  height: 100%;
  border: none;
}
`;

/**
 * GitHub Markdown CSS (embedded for iframe isolation)
 */
const githubMarkdownCSS = `
.markdown-body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
  padding: 24px;
  color: #24292f;
  background: #ffffff;
  box-sizing: border-box;
}

.markdown-body h1, .markdown-body h2 {
  padding-bottom: 0.3em;
  border-bottom: 1px solid #d0d7de;
}

.markdown-body h1 {
  font-size: 2em;
  font-weight: 600;
  margin: 24px 0 16px;
}

.markdown-body h2 {
  font-size: 1.5em;
  font-weight: 600;
  margin: 24px 0 16px;
}

.markdown-body h3 {
  font-size: 1.25em;
  font-weight: 600;
  margin: 24px 0 16px;
}

.markdown-body h4 {
  font-size: 1em;
  font-weight: 600;
  margin: 24px 0 16px;
}

.markdown-body h5, .markdown-body h6 {
  font-size: 0.875em;
  font-weight: 600;
  margin: 24px 0 16px;
}

.markdown-body p {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 1em;
  color: #57606a;
  border-left: 0.25em solid #d0d7de;
  margin: 0 0 16px;
}

.markdown-body code {
  padding: 0.2em 0.4em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(175,184,193,0.2);
  border-radius: 6px;
  font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace;
}

.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f6f8fa;
  border-radius: 6px;
  margin-bottom: 16px;
}

.markdown-body pre code {
  display: inline;
  padding: 0;
  margin: 0;
  overflow: visible;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body table {
  border-spacing: 0;
  border-collapse: collapse;
  display: block;
  width: max-content;
  max-width: 100%;
  overflow: auto;
  margin-bottom: 16px;
}

.markdown-body table th {
  font-weight: 600;
  padding: 6px 13px;
  border: 1px solid #d0d7de;
  background-color: #f6f8fa;
}

.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #d0d7de;
}

.markdown-body table tr {
  background-color: #ffffff;
  border-top: 1px solid #d0d7de;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f6f8fa;
}

.markdown-body ul, .markdown-body ol {
  padding-left: 2em;
  margin-bottom: 16px;
}

.markdown-body li {
  margin-top: 0.25em;
}

.markdown-body hr {
  height: 0.25em;
  padding: 0;
  margin: 24px 0;
  background-color: #d0d7de;
  border: 0;
}

.markdown-body a {
  color: #0969da;
  text-decoration: none;
}

.markdown-body a:hover {
  text-decoration: underline;
}

.markdown-body img {
  max-width: 100%;
  box-sizing: content-box;
}
`;

/**
 * Create iframe HTML document with isolated styles (GitHub Markdown style)
 */
function createIframeDocument(renderedHTML: string): string {
  return `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$']],
        displayMath: [['$$', '$$']],
        processEscapes: true,
        processEnvironments: true
      },
      startup: {
        ready: () => {
          console.log('[CopyLLM iframe] MathJax config ready');
          MathJax.startup.defaultReady();
        },
        pageReady: () => {
          console.log('[CopyLLM iframe] MathJax page ready, starting typeset...');
          return MathJax.startup.defaultPageReady().then(() => {
            console.log('[CopyLLM iframe] MathJax typeset complete!');
            const mathElements = document.querySelectorAll('.MathJax, mjx-container');
            console.log('[CopyLLM iframe] Math elements rendered:', mathElements.length);
            
            // Debug: log all text nodes containing $
            const body = document.body.innerHTML;
            const dollarCount = (body.match(/\$/g) || []).length;
            console.log('[CopyLLM iframe] Dollar signs in HTML:', dollarCount);
            if (dollarCount > 0 && mathElements.length === 0) {
              console.warn('[CopyLLM iframe] Found $ but no math rendered! Checking content...');
              console.log('[CopyLLM iframe] Body preview:', body.substring(0, 500));
            }
          });
        }
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea'],
        processHtmlClass: 'markdown-body'
      }
    };
    console.log('[CopyLLM iframe] MathJax config loaded');
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    ${githubMarkdownCSS}
    
    body {
      margin: 0;
      padding: 0;
      background: #ffffff;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="markdown-body">
    ${renderedHTML}
  </div>
</body>
</html>`;
}

/**
 * Re-render panel that displays Markdown with proper formatting
 * Uses iframe for complete CSS isolation (blog-style rendering)
 */
export class ReRenderPanel {
  private container: HTMLElement | null = null;
  private md: MarkdownIt;
  private mathPlaceholders: Map<string, string> = new Map();

  constructor() {
    // Initialize markdown-it with simple config
    this.md = new MarkdownIt({
      html: false,
      breaks: true,
      linkify: true,
      typographer: true
    });
  }

  /**
   * Protect math formulas before markdown rendering
   */
  private protectMath(markdown: string): string {
    this.mathPlaceholders.clear();
    let counter = 0;

    // Protect display math ($$...$$)
    // Use HTML comment format to prevent markdown-it from processing
    markdown = markdown.replace(/\$\$([^$]+?)\$\$/g, (_match, formula) => {
      const placeholder = `<!--MATH-DISPLAY-${counter}-->`;
      this.mathPlaceholders.set(placeholder, `$$${formula}$$`);
      counter++;
      return placeholder;
    });

    // Protect inline math ($...$)
    markdown = markdown.replace(/\$([^$\n]+?)\$/g, (_match, formula) => {
      const placeholder = `<!--MATH-INLINE-${counter}-->`;
      this.mathPlaceholders.set(placeholder, `$${formula}$`);
      counter++;
      return placeholder;
    });

    return markdown;
  }

  /**
   * Restore math formulas after markdown rendering
   */
  private restoreMath(html: string): string {
    this.mathPlaceholders.forEach((formula, placeholder) => {
      // HTML comments are preserved by markdown-it, no need to escape
      html = html.replace(new RegExp(placeholder, 'g'), formula);
    });
    return html;
  }

  /**
   * Show panel with rendered Markdown
   */
  show(markdown: string): void {
    // Hide existing panel if any
    this.hide();

    // Inject panel styles
    if (!document.querySelector('#copyllm-panel-styles')) {
      const style = document.createElement('style');
      style.id = 'copyllm-panel-styles';
      style.textContent = panelStyles;
      document.head.appendChild(style);
    }

    // Create panel
    this.createPanel(markdown);
  }

  /**
   * Hide panel
   */
  hide(): void {
    if (this.container) {
      this.container.remove();
      this.container = null;
    }
  }

  /**
   * Create panel UI with iframe isolation
   */
  private createPanel(markdown: string): void {
    // Step 1: Protect math formulas
    const protectedMarkdown = this.protectMath(markdown);
    
    // Step 2: Render Markdown to HTML
    const html = this.md.render(protectedMarkdown);
    
    // Step 3: Restore math formulas
    const restored = this.restoreMath(html);
    
    // Step 4: Create iframe document with MathJax
    const iframeDoc = createIframeDocument(restored);

    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'copyllm-panel-overlay';
    overlay.addEventListener('click', () => this.hide());

    // Create panel
    const panel = document.createElement('div');
    panel.className = 'copyllm-panel';
    panel.addEventListener('click', (e) => e.stopPropagation());

    // Header
    const header = document.createElement('div');
    header.className = 'copyllm-panel-header';
    header.innerHTML = `
      <h2 class="copyllm-panel-title">Rendered Markdown</h2>
      <button class="copyllm-panel-close" aria-label="Close">×</button>
    `;

    // Body with iframe
    const body = document.createElement('div');
    body.className = 'copyllm-panel-body';

    const iframe = document.createElement('iframe');
    iframe.className = 'copyllm-panel-iframe';
    // 严格的沙箱设置：仅允许same-origin和scripts（MathJax需要）
    iframe.sandbox.add('allow-same-origin', 'allow-scripts');
    // 完全隔离：重置所有继承的CSS
    iframe.style.cssText = 'all: initial; width: 100%; height: 100%; border: none; display: block;';
    iframe.srcdoc = iframeDoc;

    body.appendChild(iframe);
    panel.appendChild(header);
    panel.appendChild(body);

    // Assemble
    this.container = document.createElement('div');
    this.container.appendChild(overlay);
    this.container.appendChild(panel);
    document.body.appendChild(this.container);

    // Event listeners
    const closeBtn = header.querySelector('.copyllm-panel-close');
    closeBtn?.addEventListener('click', () => this.hide());

    // ESC key
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        this.hide();
        document.removeEventListener('keydown', handleEscape);
      }
    };
    document.addEventListener('keydown', handleEscape);
  }
}
